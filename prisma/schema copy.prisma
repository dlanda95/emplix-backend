generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum SystemRole {
  GLOBAL_ADMIN
  COMPANY_ADMIN
  USER
}

enum EmployeeStatus {
  ACTIVE
  TERMINATED
  ON_LEAVE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestType {
  VACATION
  PERMIT
  SICK_LEAVE
  HOME_OFFICE
  PROFILE_UPDATE
}

// 游댠 NUEVO: Para l칩gica de Asistencia Robusta
enum AttendanceSource {
  BIOMETRIC      // Huellero f칤sico
  MOBILE_APP     // App (Geolocalizaci칩n)
  WEB_PORTAL     // Marcaci칩n web
  SYSTEM_AUTO    // Generado por Cron Job (No fiscalizados)
  MANUAL_HR      // Correcci칩n humana
}

enum AttendanceStatus {
  PENDING
  PRESENT_ON_TIME
  LATE
  ABSENT_JUSTIFIED
  ABSENT_UNJUSTIFIED
  VACATION
  MEDICAL_LEAVE
  HOLIDAY
  DAY_OFF
}

enum AuthProvider {
  LOCAL
  MICROSOFT
}



enum TenantType {
  SHARED
  ISOLATED
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
}

// 1. Definimos los tipos de documentos
enum DocumentType {
  AVATAR          // P칰blico (Foto de perfil)
  CONTRACT        // Privado (Solo RRHH y Empleado)
  ID_CARD         // Privado (DNI, Pasaporte)
  CERTIFICATION   // Semi-P칰blico (Diplomas)
  MEDICAL         // Estrictamente Privado (Bajas m칠dicas)
  OTHER
}



// --- MODELOS ---

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  type      TenantType   @default(SHARED)
  status    TenantStatus @default(ACTIVE)
  dbUrl     String?      

  users     User[]
  documents Document[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("tenants")
}

model User {
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  id           String       @id @default(uuid())
  email        String
  passwordHash String?
  provider     AuthProvider @default(LOCAL)
  providerId   String?      
  isActive     Boolean      @default(true)
  role         SystemRole   @default(USER)
  
  employee     Employee?
  requests     Request[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // 칈ndice para b칰squedas r치pidas de login
  @@unique([email, tenantId])
  // 칈ndice para listar usuarios de una empresa r치pidamente
  @@index([tenantId]) 
  @@map("users")
}

model Employee {
  tenantId       String
  id             String         @id @default(uuid())

  firstName      String
  middleName     String?
  lastName       String
  secondLastName String?
  birthDate      DateTime?
  
  documentId     String?
  gender         String?
  personalEmail  String?
  phone          String?
  address        String?
  
  emergencyName  String?
  emergencyPhone String?
  emergencyRel   String?

  hireDate       DateTime
  contractType   ContractType   @default(FULL_TIME)
  status         EmployeeStatus @default(ACTIVE)

  userId         String         @unique
  user           User           @relation(fields: [userId], references: [id])

  departmentId   String?
  department     Department?    @relation(fields: [departmentId], references: [id])

  positionId     String?
  position       Position?      @relation(fields: [positionId], references: [id])

  supervisorId   String?
  supervisor     Employee?      @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates   Employee[]     @relation("Hierarchy")
  documents      Document[]
  attendances    Attendance[]
  sentKudos      Kudo[]         @relation("Sender")
  receivedKudos  Kudo[]         @relation("Receiver")

// Relaci칩n inversa
  documents Document[]
// 游댠 RELACI칍N CLAVE: Datos Laborales
  laborData      EmployeeLaborData?

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([documentId, tenantId])
  // OPTIMIZACI칍N: 칈ndice para filtrar empleados por tenant + estado (Dashboard)
  @@index([tenantId, status]) 
  // OPTIMIZACI칍N: 칈ndice para buscar por supervisor dentro de la empresa
  @@index([tenantId, supervisorId])
  @@map("employees")
}

model Request {
  tenantId  String
  id        String        @id @default(uuid())
  type      RequestType
  status    RequestStatus @default(PENDING)
  startDate DateTime?
  endDate   DateTime?
  reason    String?
  data      Json?         

  userId    String
  user      User          @relation(fields: [userId], references: [id])

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // OPTIMIZACI칍N: Filtro r치pido de "Solicitudes Pendientes por Empresa"
  @@index([tenantId, status]) 
  // OPTIMIZACI칍N: Historial de usuario
  @@index([tenantId, userId])
  @@map("requests")
}

// Cat치logo de Tipos de Contrato (Indeterminado, Plazo Fijo, Locaci칩n)
model ContractType {
  id          String   @id @default(uuid())
  tenantId    String   // 游댠 CR칈TICO: Cada empresa define sus contratos o c칩digos
  
  name        String   // "Indeterminado", "Plazo Fijo", "Locaci칩n"
  code        String?  // C칩digo interno (ej: SUNAT)
  
  hasBenefits Boolean  @default(true) // 쯊iene CTS/Grati? (Locaci칩n = false)
  isLaboral   Boolean  @default(true) // 쯌a a planilla?
  
  employees   EmployeeLaborData[]

  @@unique([name, tenantId])
  @@map("contract_types")
}

model Department {
  tenantId    String
  id          String     @id @default(uuid())
  name        String     
  code        String?  
  description String?
  
  employees   Employee[]
  positions   Position[] 
  leaderId    String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([name, tenantId])
  @@unique([code, tenantId])
  @@index([tenantId]) // 칈ndice simple para listar
  @@map("departments")
}

model Position {
  tenantId    String
  id          String     @id @default(uuid())
  name        String     
  description String?
  employees   Employee[]
  
  departmentId String? 
  department   Department? @relation(fields: [departmentId], references: [id])

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId]) // 칈ndice simple para listar
  @@map("positions")
}

model Attendance {
  tenantId   String
  id         String   @id @default(uuid())
  date       DateTime @db.Date 
  checkIn    DateTime
  checkOut   DateTime?
  


  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])





// 游댠 L칩gica Avanzada
  source      AttendanceSource @default(BIOMETRIC) 
  status      AttendanceStatus @default(PENDING)
  
  // Auditor칤a (Si fue manual)
  isManual    Boolean  @default(false)

  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([employeeId, date])
  // OPTIMIZACI칍N CR칈TICA: Reportes de asistencia por rango de fechas en la empresa
  @@index([tenantId, date]) 
  @@map("attendances")
}






// Configuraci칩n de Horarios (El Lego m치s importante para asistencia)
model WorkShift {
  id          String   @id @default(uuid())
  tenantId    String   // 游댠 CR칈TICO
  
  name        String   // "Administrativo", "Gerencia", "Planta Noche"
  
  // --- Fiscalizaci칩n ---
  isFiscalized Boolean @default(true) // TRUE = Marca asistencia, FALSE = Autom치tico
  
  // --- Reglas (Solo si isFiscalized = true) ---
  startTime   String?  // "09:00"
  endTime     String?  // "18:00"
  breakTime   Int      @default(60) // Minutos de refrigerio
  tolerance   Int      @default(5)  // Minutos de tolerancia
  
  // --- Extras ---
  allowsOvertime Boolean @default(false)
  
  employees   EmployeeLaborData[]

  @@map("work_shifts")
}


// Datos Laborales (Separado para historiales futuros y orden)
model EmployeeLaborData {
  id             String   @id @default(uuid())
  // tenantId    String // Opcional aqu칤 si siempre se accede v칤a Employee, pero recomendable por seguridad
  
  employeeId     String   @unique
  employee       Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // V칤nculos (Lego)
  contractTypeId String
  contractType   ContractType @relation(fields: [contractTypeId], references: [id])
  
  workShiftId    String
  workShift      WorkShift    @relation(fields: [workShiftId], references: [id])
  
  salary         Decimal  @default(0.0)
  currency       String   @default("PEN")
  
  @@map("employee_labor_data")
}

model Kudo {
  tenantId     String
  id           String   @id @default(uuid())
  message      String
  categoryCode String
  createdAt    DateTime @default(now())
  
  senderId     String
  sender       Employee @relation("Sender", fields: [senderId], references: [id])

  receiverId   String
  receiver     Employee @relation("Receiver", fields: [receiverId], references: [id])

  // OPTIMIZACI칍N: Ranking de Kudos de la empresa
  @@index([tenantId, createdAt])
  @@map("kudos")





  
}



// 2. Nueva Tabla: Documentos
model Document {
  id          String   @id @default(uuid())
  tenantId    String   // Multi-tenant: fundamental
  
  // Metadatos del Archivo
  name        String   // Nombre original: "contrato_firmado.pdf"
  originalName String? // Nombre que subi칩 el usuario
  mimeType    String   // "application/pdf", "image/png"
  size        Int      // Peso en bytes (칰til para estad칤sticas)
  
  // Ubicaci칩n en Azure
  // Guardaremos la ruta relativa: "tenants/techgans/employees/juan/contract.pdf"
  path        String   
  
  // Clasificaci칩n y Seguridad
  type        DocumentType @default(OTHER)
  isPublic    Boolean      @default(false) // <--- CLAVE DE SEGURIDAD

  // Relaciones
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Auditor칤a (쯈ui칠n lo subi칩?)
  uploadedBy  String   // ID del User (RRHH)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaci칩n con Tenant para integridad referencial (opcional pero recomendada)
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, employeeId])
  @@index([type])
}