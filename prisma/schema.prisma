// --------------------------------------------------------
// 1. CONFIGURACI칍N E INSTANCIAS
// --------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// 2. ENUMS DEL SISTEMA (Globales)
// --------------------------------------------------------

enum SystemRole {
  GLOBAL_ADMIN
  COMPANY_ADMIN
  USER
}

enum AuthProvider {
  LOCAL
  MICROSOFT
}

enum TenantType {
  SHARED
  ISOLATED
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
}

// NOTA: Eliminamos ContractType Enum porque ahora es una Tabla Din치mica

enum EmployeeStatus {
  ACTIVE
  TERMINATED
  ON_LEAVE
}

// Para solicitudes (Vacaciones, Permisos)
enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestType {
  VACATION
  PERMIT
  SICK_LEAVE
  HOME_OFFICE
  PROFILE_UPDATE
}

enum DocumentType {
  AVATAR
  CONTRACT
  ID_CARD
  CERTIFICATION
  MEDICAL
  OTHER
}

// 游댠 NUEVOS ENUMS: Para l칩gica de Asistencia Robusta
enum AttendanceSource {
  BIOMETRIC      // Huellero f칤sico
  MOBILE_APP     // App (Geolocalizaci칩n)
  WEB_PORTAL     // Marcaci칩n web
  SYSTEM_AUTO    // Generado por Cron Job (No fiscalizados)
  MANUAL_HR      // Correcci칩n humana
}

enum AttendanceStatus {
  PENDING
  PRESENT_ON_TIME
  LATE
  ABSENT_JUSTIFIED
  ABSENT_UNJUSTIFIED
  VACATION
  MEDICAL_LEAVE
  HOLIDAY
  DAY_OFF
}

// --------------------------------------------------------
// 3. MODELOS PRINCIPALES (SISTEMA)
// --------------------------------------------------------

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  type      TenantType   @default(SHARED)
  status    TenantStatus @default(ACTIVE)
  dbUrl     String?      
  
  users     User[]
  employees Employee[] // Relaci칩n directa para conteos r치pidos
  documents Document[]
  
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("tenants")
}

model User {
  id           String       @id @default(uuid())
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  
  email        String
  passwordHash String?
  provider     AuthProvider @default(LOCAL)
  providerId   String?      
  isActive     Boolean      @default(true)
  role         SystemRole   @default(USER)
   
  employee     Employee?
  requests     Request[]
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([email, tenantId]) 
  @@index([tenantId]) 
  @@map("users")
}

// --------------------------------------------------------
// 4. M칍DULO ORGANIZACIONAL (Estructura)
// --------------------------------------------------------

model Department {
  id          String     @id @default(uuid())
  tenantId    String     
  
  name        String      
  code        String?   
  description String?
   
  employees   Employee[]
  positions   Position[] 
  
  // Opcional: L칤der del 치rea
  leaderId    String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([name, tenantId])
  @@unique([code, tenantId])
  @@index([tenantId])
  @@map("departments")
}

model Position {
  id           String      @id @default(uuid())
  tenantId     String      
  
  name         String      
  description  String?
  
  departmentId String? 
  department   Department? @relation(fields: [departmentId], references: [id])
  
  employees    Employee[] 

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("positions")
}

// --------------------------------------------------------
// 5. M칍DULO CONFIGURACI칍N LABORAL (CAT츼LOGOS)
// --------------------------------------------------------

// Cat치logo de Tipos de Contrato (Indeterminado, Plazo Fijo, Locaci칩n)
model ContractType {
  id          String   @id @default(uuid())
  tenantId    String   
  
  name        String   // "Indeterminado", "Plazo Fijo", "Locaci칩n"
  code        String?  // C칩digo interno (ej: SUNAT)
  
  hasBenefits Boolean  @default(true) // 쯊iene CTS/Grati? (Locaci칩n = false)
  isLaboral   Boolean  @default(true) // 쯌a a planilla?
  
  employees   EmployeeLaborData[]

  @@unique([name, tenantId])
  @@map("contract_types")
}

// Configuraci칩n de Horarios (El Lego m치s importante para asistencia)
model WorkShift {
  id          String   @id @default(uuid())
  tenantId    String   
  
  name        String   // "Administrativo", "Gerencia", "Planta Noche"
  
  // --- Fiscalizaci칩n ---
  isFiscalized Boolean @default(true) // TRUE = Marca asistencia, FALSE = Autom치tico
  
  // --- Reglas (Solo si isFiscalized = true) ---
  startTime   String?  // "09:00"
  endTime     String?  // "18:00"
  breakTime   Int      @default(60) // Minutos de refrigerio
  tolerance   Int      @default(5)  // Minutos de tolerancia
  
  // --- Extras ---
  allowsOvertime Boolean @default(false)
  
  employees   EmployeeLaborData[]

  @@map("work_shifts")
}

// --------------------------------------------------------
// 6. M칍DULO EMPLEADO (Perfil + Laboral)
// --------------------------------------------------------

model Employee {
  id             String   @id @default(uuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  // Datos Personales
  firstName      String
  middleName     String?
  lastName       String
  secondLastName String?
  birthDate      DateTime?
  
  documentId     String?  // DNI/CE
  gender         String?
  personalEmail  String?
  phone          String?
  address        String?
  
  emergencyName  String?
  emergencyPhone String?
  emergencyRel   String?
  
  // Datos Sistema (B치sicos)
  status         EmployeeStatus @default(ACTIVE)
  hireDate       DateTime
  
  // Relaciones Estructurales
  userId         String?   @unique
  user           User?     @relation(fields: [userId], references: [id])
  
  departmentId   String?
  department     Department? @relation(fields: [departmentId], references: [id])
  
  positionId     String?
  position       Position?   @relation(fields: [positionId], references: [id])
  
  // Jerarqu칤a
  supervisorId   String?
  supervisor     Employee?   @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates   Employee[]  @relation("Hierarchy")
  
  // 游댠 RELACI칍N CLAVE: Datos Laborales (Separado del perfil)
  laborData      EmployeeLaborData?

  // Operaciones
  attendances    Attendance[]
  documents      Document[]
  requests       Request[]   // Vacaciones, etc.
  
  // Kudos (Reconocimientos)
  sentKudos      Kudo[]      @relation("Sender")
  receivedKudos  Kudo[]      @relation("Receiver")

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([documentId, tenantId])
  @@index([tenantId, status]) 
  @@index([tenantId, supervisorId])
  @@map("employees")
}

// Datos Laborales (Separado para historiales futuros y orden)
model EmployeeLaborData {
  id             String   @id @default(uuid())
  // tenantId    String // Opcional aqu칤
  
  employeeId     String   @unique
  employee       Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // V칤nculos (Lego)
  contractTypeId String
  contractType   ContractType @relation(fields: [contractTypeId], references: [id])
  
  workShiftId    String
  workShift      WorkShift    @relation(fields: [workShiftId], references: [id])
  
  // Jerarqu칤a salarial
  hierarchyLevel String // "OPERATIVO", "JEFE", etc.
  
  startDate      DateTime
  endDate        DateTime? // Null = Activo
  salary         Decimal  @default(0.0)
  currency       String   @default("PEN")
  
  @@map("employee_labor_data")
}

// --------------------------------------------------------
// 7. M칍DULO ASISTENCIA (Operacional)
// --------------------------------------------------------

model Attendance {
  id          String   @id @default(uuid())
  tenantId    String   
  
  date        DateTime @db.Date 
  
  checkIn     DateTime?
  checkOut    DateTime?
  
  // 游댠 L칩gica Avanzada
  source      AttendanceSource @default(BIOMETRIC) 
  status      AttendanceStatus @default(PENDING)
  
  // Metadatos Calculados
  hoursWorked Decimal? @default(0)
  
  // Auditor칤a (Si fue manual)
  isManual    Boolean  @default(false)
  editedBy    String?
  editReason  String?
  
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([tenantId, date]) 
  @@map("attendances")
}

// --------------------------------------------------------
// 8. OTROS M칍DULOS (Requests, Kudos, Docs)
// --------------------------------------------------------

model Request {
  id        String        @id @default(uuid())
  tenantId  String
  
  type      RequestType
  status    RequestStatus @default(PENDING)
  startDate DateTime?
  endDate   DateTime?
  reason    String?
  data      Json?         

  // Qui칠n solicita (Usuario o Empleado - vinculamos al empleado para reportes)
  employeeId String?      // Opcional por migraci칩n, pero idealmente obligatorio
  employee   Employee?    @relation(fields: [employeeId], references: [id])
  
  // Usuario que cre칩 el registro (login)
  userId    String
  user      User          @relation(fields: [userId], references: [id])

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([tenantId, status]) 
  @@map("requests")
}

model Kudo {
  id           String   @id @default(uuid())
  tenantId     String   
  
  message      String
  categoryCode String
  
  senderId     String
  sender       Employee @relation("Sender", fields: [senderId], references: [id])

  receiverId   String
  receiver     Employee @relation("Receiver", fields: [receiverId], references: [id])

  createdAt    DateTime @default(now())

  @@index([tenantId, createdAt])
  @@map("kudos")
}

model Document {
  id           String       @id @default(uuid())
  tenantId     String       
  
  name         String   
  originalName String?
  mimeType     String   
  size         Int      
  path         String   
  
  type         DocumentType @default(OTHER)
  isPublic     Boolean      @default(false)

  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Relaci칩n opcional con Tenant para consistencia
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  
  uploadedBy   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([tenantId, employeeId])
  @@index([type])
  @@map("documents")
}