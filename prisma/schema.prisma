generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum SystemRole {
  GLOBAL_ADMIN
  COMPANY_ADMIN
  USER
}

enum EmployeeStatus {
  ACTIVE
  TERMINATED
  ON_LEAVE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestType {
  VACATION
  PERMIT
  SICK_LEAVE
  HOME_OFFICE
  PROFILE_UPDATE
}

enum ContractType {
  FULL_TIME
  PART_TIME
  INTERNSHIP
  CONTRACTOR
}

enum AuthProvider {
  LOCAL
  MICROSOFT
}

enum TenantType {
  SHARED
  ISOLATED
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
}

// --- MODELOS ---

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  type      TenantType   @default(SHARED)
  status    TenantStatus @default(ACTIVE)
  dbUrl     String?      

  users     User[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("tenants")
}

model User {
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  id           String       @id @default(uuid())
  email        String
  passwordHash String?
  provider     AuthProvider @default(LOCAL)
  providerId   String?      
  isActive     Boolean      @default(true)
  role         SystemRole   @default(USER)
  
  employee     Employee?
  requests     Request[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Índice para búsquedas rápidas de login
  @@unique([email, tenantId])
  // Índice para listar usuarios de una empresa rápidamente
  @@index([tenantId]) 
  @@map("users")
}

model Employee {
  tenantId       String
  id             String         @id @default(uuid())

  firstName      String
  middleName     String?
  lastName       String
  secondLastName String?
  birthDate      DateTime?
  
  documentId     String?
  gender         String?
  personalEmail  String?
  phone          String?
  address        String?
  
  emergencyName  String?
  emergencyPhone String?
  emergencyRel   String?

  hireDate       DateTime
  contractType   ContractType   @default(FULL_TIME)
  status         EmployeeStatus @default(ACTIVE)

  userId         String         @unique
  user           User           @relation(fields: [userId], references: [id])

  departmentId   String?
  department     Department?    @relation(fields: [departmentId], references: [id])

  positionId     String?
  position       Position?      @relation(fields: [positionId], references: [id])

  supervisorId   String?
  supervisor     Employee?      @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates   Employee[]     @relation("Hierarchy")
  
  attendances    Attendance[]
  sentKudos      Kudo[]         @relation("Sender")
  receivedKudos  Kudo[]         @relation("Receiver")

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([documentId, tenantId])
  // OPTIMIZACIÓN: Índice para filtrar empleados por tenant + estado (Dashboard)
  @@index([tenantId, status]) 
  // OPTIMIZACIÓN: Índice para buscar por supervisor dentro de la empresa
  @@index([tenantId, supervisorId])
  @@map("employees")
}

model Request {
  tenantId  String
  id        String        @id @default(uuid())
  type      RequestType
  status    RequestStatus @default(PENDING)
  startDate DateTime?
  endDate   DateTime?
  reason    String?
  data      Json?         

  userId    String
  user      User          @relation(fields: [userId], references: [id])

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // OPTIMIZACIÓN: Filtro rápido de "Solicitudes Pendientes por Empresa"
  @@index([tenantId, status]) 
  // OPTIMIZACIÓN: Historial de usuario
  @@index([tenantId, userId])
  @@map("requests")
}

model Department {
  tenantId    String
  id          String     @id @default(uuid())
  name        String     
  code        String?  
  description String?
  
  employees   Employee[]
  positions   Position[] 
  leaderId    String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([name, tenantId])
  @@unique([code, tenantId])
  @@index([tenantId]) // Índice simple para listar
  @@map("departments")
}

model Position {
  tenantId    String
  id          String     @id @default(uuid())
  name        String     
  description String?
  employees   Employee[]
  
  departmentId String? 
  department   Department? @relation(fields: [departmentId], references: [id])

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId]) // Índice simple para listar
  @@map("positions")
}

model Attendance {
  tenantId   String
  id         String   @id @default(uuid())
  date       DateTime @db.Date 
  checkIn    DateTime
  checkOut   DateTime?
  
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([employeeId, date])
  // OPTIMIZACIÓN CRÍTICA: Reportes de asistencia por rango de fechas en la empresa
  @@index([tenantId, date]) 
  @@map("attendances")
}

model Kudo {
  tenantId     String
  id           String   @id @default(uuid())
  message      String
  categoryCode String
  createdAt    DateTime @default(now())
  
  senderId     String
  sender       Employee @relation("Sender", fields: [senderId], references: [id])

  receiverId   String
  receiver     Employee @relation("Receiver", fields: [receiverId], references: [id])

  // OPTIMIZACIÓN: Ranking de Kudos de la empresa
  @@index([tenantId, createdAt])
  @@map("kudos")
}