generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum SystemRole {
  GLOBAL_ADMIN
  COMPANY_ADMIN
  USER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestType {
  VACATION
  PERMIT
  SICK_LEAVE
  HOME_OFFICE
  PROFILE_UPDATE // <--- NUEVO TIPO PARA CAMBIOS DE DATOS
}

enum ContractType {
  FULL_TIME
  PART_TIME
  INTERNSHIP
  CONTRACTOR
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

// --- MODELOS ---

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  passwordHash  String?
  isActive      Boolean     @default(true)
  role          SystemRole  @default(USER)
  
  employee      Employee?
  requests      Request[]   // Un usuario hace solicitudes

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("users")
}

model Employee {
  id            String    @id @default(uuid())
  
  // --- NOMBRES ATÓMICOS (Estructura Solicitada) ---
  firstName      String   // Primer Nombre
  middleName     String?  // Segundo Nombre (Opcional)
  lastName       String   // Apellido Paterno
  secondLastName String?  // Apellido Materno (Opcional)
  
  // --- FECHA ---
  // Mantenemos 'birthDate' como pediste, formato DateTime
  birthDate      DateTime?
  
  // Identificación
  documentId    String?   @unique
  gender        String?
  
  // Datos de Contacto
  personalEmail String?
  phone         String?
  address       String?
  
  // Datos de Emergencia
  emergencyName  String?
  emergencyPhone String?
  emergencyRel   String?
  
  // Datos Laborales
  hireDate      DateTime
  contractType  ContractType @default(FULL_TIME)
  status        EmployeeStatus @default(ACTIVE)
  
  // Relaciones
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])

  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])

  positionId    String?
  position      Position?   @relation(fields: [positionId], references: [id])

  supervisorId  String?
  supervisor    Employee?   @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates  Employee[]  @relation("Hierarchy")
  attendances   Attendance[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("employees")
}

model Request {
  id          String        @id @default(uuid())
  type        RequestType
  status      RequestStatus @default(PENDING)
  
  // Fechas (para vacaciones/permisos)
  startDate   DateTime?
  endDate     DateTime?
  reason      String?
  
  // Payload de Datos (Para PROFILE_UPDATE)
  // Aquí guardaremos el objeto JSON con los cambios solicitados:
  // { "phone": "999...", "address": "Nueva Calle 123" }
  data        Json?         

  userId      String
  user        User          @relation(fields: [userId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("requests")
}

// Catálogos
model Department {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  employees   Employee[]
  
  // NUEVA RELACIÓN: Un departamento tiene muchos cargos
  positions   Position[] 

  createdAt   DateTime   @default(now())
  @@map("departments")
}

model Position {
  id          String     @id @default(uuid())
  name        String     @unique // Ojo: Si quieres "Analista" en varias áreas, quita el @unique
  description String?
  employees   Employee[]
  
  // NUEVA RELACIÓN: Un cargo pertenece a un departamento
  departmentId String? 
  department   Department? @relation(fields: [departmentId], references: [id])

  createdAt   DateTime   @default(now())
  @@map("positions")
}


model Attendance {
  id          String    @id @default(uuid())
  
  // Fecha sin hora para agrupar reportes
  date        DateTime  @db.Date 
  
  checkIn     DateTime  // Hora exacta de entrada
  checkOut    DateTime? // Hora exacta de salida (puede ser nulo si sigue trabajando)
  
  // Relación con Empleado
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Restricción: Un empleado solo puede tener una ficha de asistencia por día
  @@unique([employeeId, date])
  @@map("attendances")
}